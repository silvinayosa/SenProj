<script src="https://js.stripe.com/v3/"></script>

<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">Recommended Venues</h1>
    <div id="venue-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">


        <!-- Venue options will be populated here dynamically -->
    </div>
    <button id="see-more" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">See More</button>
    <div class="mt-6 text-center">
        <h2 class="text-xl font-semibold mb-4">Already Have a Venue?</h2>
        <button id="use-private-venue"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
            Use My Private Home
        </button>
    </div>

    <div class="mt-6 text-center">
        <button id="checkout-button"
            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 disabled:opacity-50"
            disabled>
            Pay
        </button>
    </div>
</div>

<script>
    const stripe = Stripe('pk_test_51QFDthGl6As4Qq0gKLYXJ9T5UABXcqLBf7wWGD1BnxNd5srpP0W0qVTi05jdJ9jIzUsnxrmkm6gmjojhoOVILJZd00cfISUls5'); // Replace with your Stripe Publishable Key

    document.getElementById('checkout-button').addEventListener('click', async () => {
        // Get the price for the selected venue
        const selectedVenue = document.querySelector('#venue-list div.bg-green-200');
        const price = selectedVenue.querySelector('p.text-gray-700:nth-child(3)').textContent.split('$')[1];
        
        console.log('Price:', price);
        const response = await fetch('/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ price,budget})
        });
        
        const session = await response.json();
        await stripe.redirectToCheckout({ sessionId: session.id });
    });
</script>

<script>

    const venues = JSON.parse(sessionStorage.getItem('venues')) || [];
    
    const budget = sessionStorage.getItem('budget');
    const venueList = document.getElementById('venue-list');
    const seeMoreButton = document.getElementById('see-more');
    const province = sessionStorage.getItem('province');
    
    console.log('Budget:', budget);
    console.log('Province:', province);

    let allShown = false; // Track whether all venues are shown

    console.log('Loaded Venues:', venues);

    // Get 3 random venues
    function getRandomVenues(venues) {
        const shuffled = venues.slice().sort(() => Math.random() - 0.5);
        return shuffled.slice(0, 3);
    }

    // Display selected venues
    function displayVenues(selectedVenues) {
        venueList.innerHTML = ''; // Clear the list before displaying

        selectedVenues.forEach((venue, index) => {
            const venueDiv = document.createElement('div');
            venueDiv.className =
                "border rounded-lg overflow-hidden shadow-lg transition-transform transform hover:scale-105 cursor-pointer";
            venueDiv.setAttribute('data-id', index);
            console.log(venue[0]);
            console.log("Venue name", venue.Co2Emission);
            venueDiv.innerHTML = `
                <div class="p-4">
                    <h3 class="text-xl font-semibold text-blue-600">${venue.Facility_Name}</h3>
                    <p class="text-gray-700">CO2 Emission: ${venue.Co2Emission} g</p>
                    <p class="text-gray-700">Cost: $${venue.Price}</p>
                    <p class="text-gray-700">Province: ${province}</p>
                </div>
            `;

            venueDiv.onclick = () => selectVenue(index);
            venueList.appendChild(venueDiv);
        });
    }

    // Handle venue selection
    function selectVenue(id) {
        document.querySelectorAll('#venue-list div').forEach(div => {
            div.classList.remove('bg-green-200', 'bg-opacity-50');
        });

        const selectedDiv = document.querySelector(`#venue-list div[data-id="${id}"]`);
        selectedDiv.classList.add('bg-green-200', 'bg-opacity-50');
        document.getElementById('checkout-button').disabled = false;
    }

    // Display initial 3 random venues
    displayVenues(getRandomVenues(venues));

    // See More button functionality
    seeMoreButton.onclick = () => {
        if (!allShown) {
            displayVenues(venues); // Show all venues
            seeMoreButton.textContent = 'Show Less';
            allShown = true;
        } else {
            displayVenues(getRandomVenues(venues)); // Show 3 random venues again
            seeMoreButton.textContent = 'See More';
            allShown = false;
        }
    };


</script>

<style>
    /* Additional styles can be added here if needed */
</style>